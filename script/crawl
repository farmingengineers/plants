#!/usr/bin/env bundle exec rails runner

require 'anemone'
require 'curb'

def main
  say_and_do :crawl_johnnys
  say_and_do :crawl_fedco
  say_and_do :crawl_high_mowing
end

def say_and_do(method)
  puts method
  send method
end

def crawl_johnnys
  with_catalog("Johnny's Selected Seeds", "http://www.johnnyseeds.com/") do |catalog|
    Anemone.crawl(catalog.url) do |anemone|
      anemone.focus_crawl do |page|
        page.links.select { |u| u.path =~ /^\/[cp]-/ and u.query.nil? }
      end
      anemone.on_every_page do |page|
        puts page.url
        if page.url.path =~ /^\/p-/
          catalog.catalog_pages.create(:url => page.url.to_s, :body => page.body)
        end
      end
    end
  end
end

def crawl_fedco
  with_catalog("Fedco Seeds", "http://www.fedcoseeds.com/") do |catalog|
    multi = Curl::Multi.new
    1.upto(6499) do |item_id|
      url = "#{catalog.url}seeds/search.php?item=#{item_id}&index=0"
      c = Curl::Easy.new(url) do |curl|
        curl.on_success { |easy| puts url ; catalog.catalog_pages.create(:url => url, :body => response.body_str) }
      end
      m.add(c)
    end
    multi.perform
  end
end

def crawl_high_mowing
  with_catalog("Johnny's Selected Seeds", "http://www.johnnyseeds.com/") do |catalog|
    Anemone.crawl("http://www.highmowingseeds.com/") do |anemone|
      anemone.focus_crawl do |page|
        page.links.select { |u| u.path =~ /^\/organic-/ }
      end
      anemone.on_every_page do |page|
        puts page.url
        catalog.catalog_pages.create(:url => page.url.to_s, :body => page.body)
      end
    end
  end
end

def with_catalog(name, url)
  Catalog.where(:url => url).destroy_all
  yield Catalog.create!(:name => name, :url => url)
end

main
